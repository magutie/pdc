name: Deploy to Hostinger via SSH (no FTP)

on:
  push:
    branches: [ "main" ]   # cambia si quieres otra rama

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
      - name: Setup SSH for GitHub
        run: |
          mkdir -p ~/.ssh
          echo "Host github.com" >> ~/.ssh/config
          echo "  HostName github.com" >> ~/.ssh/config
          echo "  User git" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/github_key" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy (git pull + deploy.sh remoto)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -Eeuo pipefail
            APP_NAME="pdc"
            APP_DIR="$HOME/apps/$APP_NAME"
            REPO_URL="https://github.com/magutie/pdc.git"
            BRANCH="main"

            # Configurar git para usar HTTPS
            git config --global url."https://github.com/".insteadOf "git@github.com:"

            # bootstrap mínimo si es la primera vez
            mkdir -p "$APP_DIR"/{repos,shared,releases}
            if [ ! -d "$APP_DIR/repos/working/.git" ]; then
              git clone --depth=1 -b "$BRANCH" "$REPO_URL" "$APP_DIR/repos/working"
            fi

            # Actualizar el repositorio primero
            cd "$APP_DIR/repos/working"
            git fetch --all --prune
            git checkout "$BRANCH"
            git pull --ff-only

            # Copiar scripts del repo al servidor
            cp "$APP_DIR/repos/working/deploy.sh" "$APP_DIR/deploy.sh"
            [ -f "$APP_DIR/repos/working/verify-paths.sh" ] && cp "$APP_DIR/repos/working/verify-paths.sh" "$APP_DIR/verify-paths.sh"
            chmod +x "$APP_DIR/deploy.sh"
            [ -f "$APP_DIR/verify-paths.sh" ] && chmod +x "$APP_DIR/verify-paths.sh"

            # Ejecutar diagnóstico si existe
            if [ -f "$APP_DIR/verify-paths.sh" ]; then
              echo "=== DIAGNÓSTICO DE RUTAS ==="
              bash "$APP_DIR/verify-paths.sh"
              echo ""
            fi

            # Ejecutar deploy
            echo "=== INICIANDO DEPLOY ==="
            bash "$APP_DIR/deploy.sh"
